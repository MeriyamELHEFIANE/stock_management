<!DOCTYPE html> 
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Créer une commande - Riad</title>
  {% load static %}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@500;600&family=Nunito+Sans:wght@400;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet"> <!-- icônes -->
  <link rel="shortcut icon" href="{% static 'assets/images/restoManager.png' %}" />
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

  <style>
    body {
      font-family: 'Nunito Sans', sans-serif;
      background: linear-gradient(160deg, #fef9f4, #f4eee3);
      min-height: 100vh;
      color: #333;
      padding-bottom: 50px;
    }

    h1 {
      font-family: 'Cormorant Garamond', serif;
      font-weight: 600;
      font-size: 3rem;
      text-align: center;
      margin: 50px 0;
      color: #6b4f3f;
    }

    /* Icône retour */
    .back-icon {
      font-size: 1.8rem;
      cursor: pointer;
      color: #b9885a;
      margin: 20px;
      display: inline-block;
      transition: transform 0.3s ease, color 0.3s ease;
    }
    .back-icon:hover {
      color: #8b6140;
      transform: scale(1.1);
    }

    .card {
      border-radius: 25px;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(12px);
      box-shadow: 0 12px 30px rgba(0,0,0,0.08);
      border: none;
      transition: transform 0.4s ease, box-shadow 0.4s ease;
    }

    .card:hover {
      transform: translateY(-10px);
      box-shadow: 0 25px 50px rgba(0,0,0,0.15);
    }

    .card-body h5 {
      font-family: 'Cormorant Garamond', serif;
      font-weight: 600;
      font-size: 1.5rem;
      margin-bottom: 10px;
      color: #5a3e2b;
    }

    label.quantite-label {
      font-weight: 600;
      font-family: 'Nunito Sans', sans-serif;
      margin-bottom: 3px;
    }

    input.quantity-input {
      border-radius: 15px;
      text-align: center;
      margin-bottom: 10px;
      border: 1px solid #c7b29b;
    }

    .btn-custom {
      border-radius: 30px;
      font-weight: 600;
      font-family: 'Nunito Sans', sans-serif;
      padding: 10px 22px;
      background-color: transparent;
      border: 2px solid #b9885a;
      color: #b9885a;
      width: 100%;
      transition: all 0.3s ease;
    }

    .btn-custom:hover {
      background-color: #b9885a;
      color: #fff;
      transform: scale(1.05);
    }

    #orderTable {
      margin-top: 20px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.08);
      transition: all 0.3s ease;
    }

    #orderTable thead {
      background-color: #f7e7d0;
      border-radius: 20px;
      font-family: 'Nunito Sans', sans-serif;
      font-weight: 600;
      color: #5a3e2b;
    }

    #orderTable tbody tr {
      transition: all 0.3s ease;
      border-bottom: 1px solid #eee;
    }

    #orderTable tbody tr.highlight {
      background-color: rgba(185,136,90,0.15);
      transform: scale(1.02);
    }

    #orderTable tbody td {
      font-family: 'Nunito Sans', sans-serif;
      font-weight: 500;
      color: #4b3f2f;
      vertical-align: middle;
    }

    #orderTable .btn-danger {
      border-radius: 20px;
      font-weight: 600;
      padding: 5px 12px;
      transition: all 0.3s ease;
    }

    #orderTable .btn-danger:hover {
      background-color: #8b6140;
      transform: scale(1.05);
      color: #fff;
    }

    #submitOrder {
      margin-top: 25px;
      border-radius: 30px;
      font-weight: 600;
      font-family: 'Nunito Sans', sans-serif;
      padding: 12px 28px;
      background-color: #b9885a;
      color: #fff;
      border: none;
      transition: all 0.3s ease;
    }

    #submitOrder:hover {
      background-color: #8b6140;
      transform: scale(1.05);
    }

    #badgesContainer {
      margin-bottom: 15px;
    }

    .plat-badge {
      display: inline-block;
      background-color: rgba(185,136,90,0.2);
      color: #5a3e2b;
      font-weight: 600;
      font-family: 'Nunito Sans', sans-serif;
      padding: 6px 14px;
      border-radius: 25px;
      margin: 4px;
      cursor: pointer;
      opacity: 0;
      transform: scale(0.5);
      animation: badgeIn 0.4s forwards;
      transition: all 0.3s ease;
    }

    .plat-badge:hover {
      background-color: #b9885a;
      color: #fff;
      transform: scale(1.1);
    }

    @keyframes badgeIn {
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    #totalPlats {
      font-weight: 600;
      font-family: 'Nunito Sans', sans-serif;
      margin-bottom: 10px;
      color: #5a3e2b;
      display: inline-block;
      transition: transform 0.3s ease;
    }
  </style>
</head>
<body>
<div class="container mt-3">
  <!-- Icône retour -->
  <i class="bi bi-house-door-fill back-icon" id="backBtn" title="Accueil"></i>


  <h1>Créer une commande</h1>

  <div id="platsContainer" class="row mb-4"></div>

  <h3>Commande actuelle</h3>
  <div id="badgesContainer"></div>
  <div id="totalPlats">Nombre total de plats: 0</div>
  <table class="table" id="orderTable">
    <thead>
      <tr>
        <th>Plat</th>
        <th>Quantité</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <button id="submitOrder">Valider la commande</button>
</div>

<script>
const apiBase = '{{ API_URL }}/api';
const urlParams = new URLSearchParams(window.location.search);
const category = urlParams.get('category')?.toLowerCase();

let plats = [];
let currentOrder = [];

// Bouton retour
document.getElementById("backBtn").addEventListener("click", () => {
  window.location.replace("{% url 'comEm' %}");
});

async function loadPlats() {
  try {
    const res = await axios.get(`${apiBase}/plats/`);
    plats = res.data.filter(p => p.description.toLowerCase() === category);
    const container = document.getElementById('platsContainer');
    plats.forEach(p => {
      const col = document.createElement('div');
      col.className = 'col-md-3 mb-4';
      col.innerHTML = `
        <div class="card shadow-sm">
          <div class="card-body text-center">
            <h5>${p.nom}</h5>
            <label class="quantite-label">Quantité</label>
            <input type="number" min="1" value="1" class="form-control quantity-input" />
            <button class="btn-custom addBtn mt-2">Ajouter</button>
          </div>
        </div>
      `;
      container.appendChild(col);

      col.querySelector('.addBtn').onclick = () => {
        const qty = parseInt(col.querySelector('.quantity-input').value);
        if(qty>0) addToOrder(p, qty);
      };
    });
  } catch(err){ console.error(err); }
}

function addToOrder(plat, qty) {
  const existing = currentOrder.find(o=>o.plat.id===plat.id);
  if(existing) existing.quantite += qty;
  else currentOrder.push({plat, quantite: qty});
  renderOrderTable(true);
}

function renderOrderTable(animate=false) {
  const tbody = document.querySelector('#orderTable tbody');
  const badgesContainer = document.getElementById('badgesContainer');
  const totalPlatsElem = document.getElementById('totalPlats');
  tbody.innerHTML = '';
  badgesContainer.innerHTML = '';

  currentOrder.forEach((o,i)=>{
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${o.plat.nom}</td>
      <td>${o.quantite}</td>
      <td><button class="btn btn-danger btn-sm">Supprimer</button></td>
    `;
    tbody.appendChild(row);

    row.querySelector('.btn-danger').onclick = () => {
      currentOrder.splice(i,1);
      renderOrderTable();
    };

    if(animate) {
      row.classList.add('highlight');
      setTimeout(()=>row.classList.remove('highlight'), 400);
    }

    const badge = document.createElement('span');
    badge.className = 'plat-badge';
    badge.innerText = `${o.plat.nom} x${o.quantite}`;
    badge.onclick = () => {
      currentOrder.splice(i,1);
      renderOrderTable();
    };
    badgesContainer.appendChild(badge);
  });

  totalPlatsElem.innerText = "Nombre total de plats: " + currentOrder.reduce((sum,o)=>sum+o.quantite,0);
  if(animate){
    totalPlatsElem.style.transform = 'scale(1.2)';
    setTimeout(()=> totalPlatsElem.style.transform='scale(1)',300);
  }
}

document.getElementById('submitOrder').onclick = async () => {
  if(currentOrder.length===0) { alert('Ajoutez au moins un plat'); return; }
  try {
    for(const o of currentOrder){
      await axios.post(`${apiBase}/commandes/`, {plat: o.plat.id, quantite: o.quantite});
    }
    alert('Commande validée !');
    currentOrder=[];
    renderOrderTable(true);
  } catch(err){ alert('Erreur lors de l\'ajout de la commande'); console.error(err);}
}

loadPlats();
</script>
</body>
</html>
